version: v1.0
name: Build & Test
agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2004
auto_cancel:
  running:
    when: 'true'

blocks:
  - name: üß™ QA
    task:
      env_vars:
        - name: MIX_ENV
          value: test
        - name: DOCKER_BUILDKIT
          value: "1"
      prologue:
        commands:
          - checkout
      jobs:
        - name: üß™ Code Format
          commands:
            - make format

        - name: üß™ Static Code Analysis
          commands:
            - make credo

        - name: üß™ Unit Test
          commands:
            - make test

      epilogue:
        always:
          commands:
            - "[[ -f out/results.xml ]] && test-results publish --name \"Unit Test\" out/results.xml"

  - name: üõ°Ô∏è Deployment Preconditions
      task:
        secrets:
          - name: security-toolbox-shared-read-access
          - name: semreg-semaphoredev-credentials
        env_vars:
          - name: MIX_ENV
            value: "prod"
          - name: DOCKER_BUILDKIT
            value: "1"

        prologue:
          commands:
            - checkout
            - mv ~/.ssh/security-toolbox ~/.ssh/id_rsa
            - sudo chmod 600 ~/.ssh/id_rsa
            - sem-version ruby 2.7
            - echo $SEMAPHORE_REGISTRY_PASSWORD | docker login --username "$SEMAPHORE_REGISTRY_USERNAME" --password-stdin $SEMAPHORE_REGISTRY_HOST
            - export REGISTRY_HOST=$SEMAPHORE_REGISTRY_HOST
            - make pull

        jobs:
          - name: üõ°Ô∏è Check Code
            commands:
              - make check.static
          - name: üõ°Ô∏è Check Dependencies
            commands:
              - make check.deps
        epilogue:
          always:
            commands:
              - "[[ -f results.xml ]] && test-results publish --name \"$SEMAPHORE_JOB_NAME\" results.xml"

after_pipeline:
  task:
    jobs:
      - name: Submit Reports
        commands:
          - test-results gen-pipeline-report

promotions:
  - name: "Release on Github"
    pipeline_file: "release.yml"
    auto_promote_on:
      - result: passed
        branch:
          - "^refs/tags/v*"